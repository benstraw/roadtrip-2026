---
import type { GalleryImage } from '../data/days';

interface Props {
  images: GalleryImage[];
  dayNum?: number;
  galleryId?: string;
  title?: string;
  emptyLabel?: string;
  lightboxImages?: GalleryImage[];
  lightboxStartIndex?: number;
}

const {
  images,
  dayNum,
  galleryId = dayNum ? 'gallery' : 'gallery-global',
  title = 'Gallery',
  emptyLabel = 'Photos coming soon',
  lightboxImages,
  lightboxStartIndex = 0,
} = Astro.props;

const hasImages = images.length > 0;
const videoCount = images.filter(i => i.video).length;
const photoCount = images.length - videoCount;
const countLabel = videoCount > 0
  ? `- ${photoCount} photo${photoCount !== 1 ? 's' : ''}, ${videoCount} video${videoCount !== 1 ? 's' : ''}`
  : `- ${images.length} photos`;

const sectionId = galleryId;
const gridId = `${galleryId}-grid`;
const lightboxId = `${galleryId}-lightbox`;
const lbCloseId = `${galleryId}-close`;
const lbPrevId = `${galleryId}-prev`;
const lbNextId = `${galleryId}-next`;
const lbImgId = `${galleryId}-img`;
const lbVideoId = `${galleryId}-video`;
const lbCaptionId = `${galleryId}-caption`;
const lbCounterId = `${galleryId}-counter`;
---

<section class="gallery-section" id={sectionId} data-gallery-id={galleryId}>
  {title && (
    <h2 class="gallery-title">
      <span class="hand">{title}</span>
      <span class="mono gallery-count">{countLabel}</span>
    </h2>
  )}

  {hasImages ? (
    <div class="pig-grid" id={gridId} role="list">
      {images.map((img, i) => (
        <figure
          class={`pig-item ${img.wide ? 'wide' : ''}`}
          data-index={i}
          role="listitem"
        >
          <button
            class="pig-trigger"
            aria-label={img.video ? `Play video: ${img.caption || img.alt}` : `Open photo: ${img.caption || img.alt}`}
            data-index={i}
          >
            <div class="pig-img-wrap">
              {img.video ? (
                <video
                  src={img.src}
                  preload="metadata"
                  muted
                  playsinline
                  class="pig-video"
                />
              ) : (
                <>
                  <img
                    src={img.src}
                    alt={img.alt}
                    loading="lazy"
                    decoding="async"
                    onerror="this.parentElement.classList.add('img-error')"
                  />
                  <div class="img-placeholder" aria-hidden="true">
                    <svg viewBox="0 0 48 48" fill="none">
                      <rect width="48" height="48" fill="none"/>
                      <path d="M8 36l10-14 8 10 6-8 10 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.3"/>
                      <circle cx="34" cy="16" r="4" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
                    </svg>
                    <span>Photo coming</span>
                  </div>
                </>
              )}
              <div class={`pig-overlay ${img.video ? 'pig-overlay--video' : ''}`} aria-hidden="true">
                {img.video ? (
                  <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="11" fill="rgba(0,0,0,0.55)" stroke="white" stroke-width="1"/>
                    <polygon points="10,8 18,12 10,16" fill="white"/>
                  </svg>
                ) : (
                  <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M15 3h6m0 0v6m0-6l-7 7M9 21H3m0 0v-6m0 6l7-7"/>
                  </svg>
                )}
              </div>
            </div>
            {img.caption && (
              <figcaption class="pig-caption">{img.caption}</figcaption>
            )}
          </button>
        </figure>
      ))}
    </div>
  ) : (
    <div class="gallery-empty">
      <p class="hand">{emptyLabel}</p>
    </div>
  )}
</section>

<div class="lightbox" id={lightboxId} role="dialog" aria-modal="true" aria-label="Media viewer" hidden>
  <button class="lb-close" aria-label="Close" id={lbCloseId}>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </button>

  <button class="lb-prev" aria-label="Previous" id={lbPrevId}>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15,18 9,12 15,6"/>
    </svg>
  </button>

  <div class="lb-content">
    <img src="" alt="" id={lbImgId} class="lb-img" style="display:none" />
    <video src="" id={lbVideoId} class="lb-video lb-img" controls playsinline style="display:none"></video>
    <div class="lb-caption-wrap">
      <p class="lb-caption" id={lbCaptionId}></p>
      <span class="lb-counter" id={lbCounterId}></span>
    </div>
  </div>

  <button class="lb-next" aria-label="Next" id={lbNextId}>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9,18 15,12 9,6"/>
    </svg>
  </button>
</div>

<script define:vars={{ images, galleryId, lightboxImages, lightboxStartIndex }}>
  const root = document.querySelector(`[data-gallery-id="${galleryId}"]`);
  const lightbox = document.getElementById(`${galleryId}-lightbox`);
  const lbImg = document.getElementById(`${galleryId}-img`);
  const lbVideo = document.getElementById(`${galleryId}-video`);
  const lbCaption = document.getElementById(`${galleryId}-caption`);
  const lbCounter = document.getElementById(`${galleryId}-counter`);
  const lbClose = document.getElementById(`${galleryId}-close`);
  const lbPrev = document.getElementById(`${galleryId}-prev`);
  const lbNext = document.getElementById(`${galleryId}-next`);

  if (!root || !lightbox || !lbImg || !lbVideo || !lbCaption || !lbCounter || !lbClose || !lbPrev || !lbNext) {
    return;
  }

  const activeImages = Array.isArray(lightboxImages) && lightboxImages.length > 0
    ? lightboxImages
    : images;
  let current = 0;

  function stopVideo() {
    if (lbVideo.style.display !== 'none') {
      lbVideo.pause();
      lbVideo.src = '';
    }
  }

  function openLightbox(index) {
    current = Math.min(index + lightboxStartIndex, activeImages.length - 1);
    updateLightbox();
    lightbox.hidden = false;
    lightbox.classList.add('visible');
    document.body.style.overflow = 'hidden';
    lbClose.focus();
  }

  function closeLightbox() {
    stopVideo();
    lightbox.classList.remove('visible');
    setTimeout(() => { lightbox.hidden = true; }, 280);
    document.body.style.overflow = '';
    const closeUrl = new URL(window.location.href);
    if (closeUrl.searchParams.get('gallery') === galleryId) {
      closeUrl.searchParams.delete('gallery');
      closeUrl.searchParams.delete('photo');
      history.replaceState({}, '', `${closeUrl.pathname}${closeUrl.search}${closeUrl.hash}`);
    }
  }

  function updateLightbox() {
    const item = activeImages[current];
    if (!item) return;

    stopVideo();

    if (item.video) {
      lbImg.style.display = 'none';
      lbVideo.style.display = '';
      lbVideo.src = item.src;
    } else {
      lbVideo.style.display = 'none';
      lbImg.style.display = '';
      lbImg.src = item.src;
      lbImg.alt = item.alt;
    }

    lbCaption.textContent = item.caption || item.alt || '';
    lbCounter.textContent = `${current + 1} / ${activeImages.length}`;
    lbPrev.disabled = current === 0;
    lbNext.disabled = current === activeImages.length - 1;

    // Keep URL shareable for the currently open slideshow position.
    if (!lightbox.hidden) {
      const nextUrl = new URL(window.location.href);
      nextUrl.searchParams.set('gallery', galleryId);
      nextUrl.searchParams.set('photo', String(current));
      history.replaceState({}, '', `${nextUrl.pathname}${nextUrl.search}${nextUrl.hash}`);
    }
  }

  function prev() {
    if (current > 0) { current--; updateLightbox(); }
  }

  function next() {
    if (current < activeImages.length - 1) { current++; updateLightbox(); }
  }

  root.querySelectorAll('.pig-trigger').forEach((btn) => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.dataset.index, 10);
      openLightbox(idx);
    });
  });

  lbClose.addEventListener('click', closeLightbox);
  lbPrev.addEventListener('click', prev);
  lbNext.addEventListener('click', next);

  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  document.addEventListener('keydown', (e) => {
    if (lightbox.hidden) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') prev();
    if (e.key === 'ArrowRight') next();
  });

  let touchStartX = 0;
  lightbox.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
  lightbox.addEventListener('touchend', (e) => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) > 50) { dx < 0 ? next() : prev(); }
  });

  // Deep-link support: open a specific slideshow at a specific index.
  const params = new URLSearchParams(window.location.search);
  if (params.get('gallery') === galleryId) {
    const requested = parseInt(params.get('photo') || '', 10);
    if (!Number.isNaN(requested)) {
      current = Math.max(0, Math.min(requested, activeImages.length - 1));
      updateLightbox();
      lightbox.hidden = false;
      lightbox.classList.add('visible');
      document.body.style.overflow = 'hidden';
    }
  }
</script>

<style>
  .gallery-section {
    padding: 3rem 0;
  }

  .gallery-title {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .gallery-title .hand {
    font-family: 'Caveat', cursive;
    font-size: 1.8rem;
    color: var(--text, #e8f4fb);
  }

  .gallery-count {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted, #8ab4cc);
    letter-spacing: 0.1em;
  }

  .pig-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    grid-auto-rows: 180px;
    gap: 6px;
  }

  .pig-item {
    position: relative;
    overflow: hidden;
    border-radius: 2px;
    background: var(--surface, #112238);
  }

  .pig-item.wide {
    grid-column: span 2;
  }

  .pig-trigger {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    text-align: left;
    padding: 0;
    border-radius: 2px;
    overflow: hidden;
  }

  .pig-img-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--surface, #112238);
  }

  .pig-img-wrap img,
  .pig-img-wrap .pig-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease, opacity 0.3s ease;
    display: block;
  }

  .pig-img-wrap.img-error img { display: none; }
  .pig-img-wrap.img-error .img-placeholder { opacity: 1; }

  .img-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    color: var(--text-muted, #8ab4cc);
    opacity: 0;
    transition: opacity 0.3s;
  }

  img[src*="placeholder"] ~ .img-placeholder,
  .pig-img-wrap:not(:has(img[src]:not([src*="placeholder"]))) .img-placeholder {
    opacity: 1;
  }

  img[src*="placeholder"] {
    opacity: 0;
  }

  .img-placeholder svg {
    width: 40px;
    height: 40px;
  }

  .img-placeholder span {
    font-family: 'Caveat', cursive;
    font-size: 0.85rem;
    color: var(--text-muted, #8ab4cc);
    opacity: 0.7;
  }

  .pig-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .pig-overlay--video {
    opacity: 0.75;
    background: transparent;
  }

  .pig-trigger:hover .pig-overlay,
  .pig-trigger:focus-visible .pig-overlay {
    opacity: 1;
  }

  .pig-trigger:hover .pig-overlay--video,
  .pig-trigger:focus-visible .pig-overlay--video {
    opacity: 1;
  }

  .expand-icon {
    width: 28px;
    height: 28px;
    color: white;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  }

  .play-icon {
    width: 48px;
    height: 48px;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,0.6));
  }

  .pig-trigger:hover .pig-img-wrap img,
  .pig-trigger:focus-visible .pig-img-wrap img,
  .pig-trigger:hover .pig-video,
  .pig-trigger:focus-visible .pig-video {
    transform: scale(1.04);
  }

  .pig-caption {
    padding: 5px 8px 6px;
    font-family: 'Caveat', cursive;
    font-size: 0.82rem;
    color: var(--text-muted, #8ab4cc);
    background: var(--surface, #112238);
    border-top: 1px solid var(--border, rgba(255,255,255,0.06));
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .gallery-empty {
    padding: 3rem;
    text-align: center;
    border: 1px dashed var(--border, rgba(255,255,255,0.1));
    border-radius: 2px;
  }

  .gallery-empty p {
    font-family: 'Caveat', cursive;
    font-size: 1.3rem;
    color: var(--text-muted, #8ab4cc);
  }

  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0,0,0,0.92);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.28s ease;
  }

  .lightbox.visible { opacity: 1; }
  .lightbox[hidden] { display: none; }

  .lb-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: min(90vw, 1200px);
    max-height: 90vh;
    gap: 0.75rem;
  }

  .lb-img {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 2px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
  }

  .lb-video {
    width: min(90vw, 960px);
    max-height: 80vh;
    border-radius: 2px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    background: #000;
  }

  .lb-caption-wrap {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    color: rgba(255,255,255,0.7);
  }

  .lb-caption {
    font-family: 'Caveat', cursive;
    font-size: 1.1rem;
  }

  .lb-counter {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    opacity: 0.5;
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  .lb-close {
    position: fixed;
    top: 1.25rem;
    right: 1.25rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 50%;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
    z-index: 10;
  }

  .lb-close:hover { color: white; border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.08); }
  .lb-close svg { width: 18px; height: 18px; }

  .lb-prev, .lb-next {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 50%;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
    z-index: 10;
  }

  .lb-prev { left: 1rem; }
  .lb-next { right: 1rem; }
  .lb-prev:hover, .lb-next:hover { color: white; border-color: rgba(255,255,255,0.4); background: rgba(255,255,255,0.06); }
  .lb-prev:disabled, .lb-next:disabled { opacity: 0.2; cursor: not-allowed; }
  .lb-prev svg, .lb-next svg { width: 20px; height: 20px; }

  @media (max-width: 640px) {
    .pig-grid {
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 140px;
    }

    .pig-item.wide { grid-column: span 2; }
  }
</style>
