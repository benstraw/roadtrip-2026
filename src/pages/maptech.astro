---
import MapNav from '../components/MapNav.astro';
---
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tech — The Road</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Raleway:wght@400;600&family=Space+Mono:wght@400;700&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #05090f; --bg-deep: #030609; --surface: #0a1018; --surface2: #0d141e;
      --accent: #c8a84a; --text: #e8e0d0; --text-muted: #5a5248; --text-dim: #3a3530;
      --border: #12181f; --border2: #1a2030;
    }
    body {
      background: var(--bg); color: var(--text);
      font-family: 'Raleway', system-ui, sans-serif;
      line-height: 1.7;
    }

    /* ─── HEADER ─── */
    .page-header {
      padding: 1.25rem 2rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;
    }
    .page-header h1 { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent); }
    .page-header .subtitle { font-size: 0.65rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-muted); }

    /* ─── LAYOUT ─── */
    .tech-body {
      max-width: 820px;
      margin: 0 auto;
      padding: 3.5rem 2rem 6rem;
    }

    /* ─── INTRO ─── */
    .intro {
      margin-bottom: 3.5rem;
      padding-bottom: 2.5rem;
      border-bottom: 1px solid var(--border);
    }
    .intro p {
      font-size: 0.95rem;
      color: #b0a898;
      max-width: 640px;
      line-height: 1.75;
    }
    .intro p + p { margin-top: 1rem; }

    /* ─── SECTIONS ─── */
    .tech-section {
      margin-bottom: 3.5rem;
      padding-bottom: 3rem;
      border-bottom: 1px solid var(--border);
    }
    .tech-section:last-child { border-bottom: none; }

    .section-label {
      font-family: 'Space Mono', monospace;
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }
    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      color: var(--text);
      margin-bottom: 1.25rem;
      line-height: 1.3;
    }

    p {
      font-size: 0.85rem;
      color: #9a9088;
      margin-bottom: 1rem;
      max-width: 640px;
    }

    strong { color: var(--text); font-weight: 600; }
    code {
      font-family: 'Space Mono', monospace;
      font-size: 0.78em;
      color: var(--accent);
      background: rgba(200, 168, 74, 0.08);
      padding: 0.1em 0.4em;
      border-radius: 2px;
    }

    /* ─── DECISION TABLE ─── */
    .decision-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      font-size: 0.78rem;
    }
    .decision-table th {
      text-align: left;
      font-family: 'Space Mono', monospace;
      font-size: 0.62rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0.6rem 1rem 0.6rem 0;
      border-bottom: 1px solid var(--border2);
    }
    .decision-table td {
      padding: 0.7rem 1rem 0.7rem 0;
      border-bottom: 1px solid var(--border);
      color: #8a8278;
      vertical-align: top;
      line-height: 1.5;
    }
    .decision-table tr:last-child td { border-bottom: none; }
    .decision-table td:first-child {
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
      color: var(--text);
      white-space: nowrap;
      padding-right: 1.5rem;
    }
    .verdict-yes { color: #7ebcd6; }
    .verdict-no  { color: var(--text-dim); }

    /* ─── CALLOUT ─── */
    .callout {
      border-left: 2px solid var(--accent);
      padding: 0.9rem 1.25rem;
      margin: 1.5rem 0;
      background: rgba(200, 168, 74, 0.04);
      border-radius: 0 4px 4px 0;
    }
    .callout p {
      margin: 0;
      color: #b0a080;
      font-size: 0.82rem;
      line-height: 1.65;
    }

    /* ─── CONSTRAINT GRID ─── */
    .constraint-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1px;
      background: var(--border2);
      margin: 1.5rem 0;
      border-radius: 4px;
      overflow: hidden;
    }
    .constraint-cell {
      background: var(--surface);
      padding: 1rem 1.1rem;
    }
    .constraint-cell .label {
      font-family: 'Space Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .constraint-cell .value {
      font-size: 0.8rem;
      color: var(--text);
      line-height: 1.45;
    }

    /* ─── PIPELINE ─── */
    .pipeline {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin: 1.5rem 0;
    }
    .pipeline-step {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      padding: 0.9rem 0;
      border-bottom: 1px solid var(--border);
    }
    .pipeline-step:last-child { border-bottom: none; }
    .step-num {
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
      color: var(--accent);
      letter-spacing: 0.1em;
      min-width: 2rem;
      padding-top: 0.1rem;
    }
    .step-body {}
    .step-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.2rem;
    }
    .step-desc {
      font-size: 0.78rem;
      color: #7a7268;
      line-height: 1.55;
      margin: 0;
      max-width: none;
    }
    .step-desc code { font-size: 0.85em; }

    @media (max-width: 600px) {
      .tech-body { padding: 2rem 1.25rem 4rem; }
      .decision-table td:first-child { white-space: normal; }
    }
  </style>
</head>
<body>

<header class="page-header">
  <h1>Tech</h1>
  <span class="subtitle">How the mapping was built</span>
  <MapNav current="tech" />
</header>

<div class="tech-body">

  <div class="intro">
    <p>
      Nine days, 3,753 miles, one Garmin device recording every second. What came out were nine GPX files totaling about 58,000 GPS points. This is a record of the decisions made to turn those into four working visualizations — a full trip overview, linked elevation profiles, a speed heatmap, and a ridge plot — on a static site with no server and no paid APIs.
    </p>
    <p>
      Every constraint in this project pushed toward the same thing: libraries that load from a CDN, render client-side, and don't require a build step. That constraint turned out to be a good design constraint.
    </p>
  </div>

  <!-- ── CONSTRAINTS ── -->
  <div class="tech-section">
    <div class="section-label">01 —</div>
    <h2 class="section-title">The Constraints</h2>
    <p>
      The site is Astro with zero server-side logic — every page is a static HTML file. That rules out server-rendered tile proxies, API gateways, and any data processing at build time. Everything has to work in the browser, loaded cold, from public endpoints.
    </p>
    <div class="constraint-grid">
      <div class="constraint-cell">
        <div class="label">Framework</div>
        <div class="value">Astro static — no server, no SSR</div>
      </div>
      <div class="constraint-cell">
        <div class="label">JavaScript</div>
        <div class="value">Vanilla only — no React, Vue, or Svelte</div>
      </div>
      <div class="constraint-cell">
        <div class="label">Libraries</div>
        <div class="value">CDN only — no npm install on experiment pages</div>
      </div>
      <div class="constraint-cell">
        <div class="label">APIs</div>
        <div class="value">No paid keys — all tile providers free-tier</div>
      </div>
      <div class="constraint-cell">
        <div class="label">GPX data</div>
        <div class="value">Client-side parse — fetch + DOMParser</div>
      </div>
      <div class="constraint-cell">
        <div class="label">Astro quirk</div>
        <div class="value"><code>is:inline</code> required on all CDN script tags</div>
      </div>
    </div>
    <div class="callout">
      <p>
        The Astro/Vite bundler hoists and processes <code>&lt;script&gt;</code> tags as ES modules, running them before CDN scripts finish loading. Adding <code>is:inline</code> tells Astro to leave the script alone and preserve document order. Without it, every Leaflet page produces <strong>L is not defined</strong> at runtime.
      </p>
    </div>
  </div>

  <!-- ── MAP LIBRARY ── -->
  <div class="tech-section">
    <div class="section-label">02 —</div>
    <h2 class="section-title">Choosing the Map Library</h2>
    <p>
      The decision was Leaflet 1.9.4. It wasn't a close call.
    </p>
    <table class="decision-table">
      <thead>
        <tr>
          <th>Library</th>
          <th>CDN size</th>
          <th>Verdict</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Leaflet 1.9.4</td>
          <td>140 KB</td>
          <td class="verdict-yes">Used</td>
          <td>Best GPX ecosystem, small, BSD licensed, tiles work out of the box</td>
        </tr>
        <tr>
          <td>MapLibre GL</td>
          <td>~900 KB</td>
          <td class="verdict-no">Skipped</td>
          <td>WebGL-based, much heavier — appropriate for vector tiles, overkill here</td>
        </tr>
        <tr>
          <td>OpenLayers</td>
          <td>~500 KB</td>
          <td class="verdict-no">Skipped</td>
          <td>Capable but verbose API; no clear advantage for raster tile + GPX use</td>
        </tr>
      </tbody>
    </table>
    <p>
      Leaflet's plugin ecosystem is the main reason. <code>leaflet-gpx</code> parses GPX files and fires a <code>loaded</code> event with computed bounds, distance, and elevation stats — no custom parsing needed for the basic route map. For the more complex visualizations, GPX was parsed manually with <code>fetch</code> + <code>DOMParser</code> to get raw point access.
    </p>
  </div>

  <!-- ── TILE PROVIDERS ── -->
  <div class="tech-section">
    <div class="section-label">03 —</div>
    <h2 class="section-title">Tile Providers</h2>
    <p>
      Eight providers were evaluated side by side on the same Day 1 track (Philadelphia to Charlotte, 536 miles). The test was legibility at zoom 5–7 — the scale that shows a full day's drive.
    </p>
    <table class="decision-table">
      <thead>
        <tr>
          <th>Provider</th>
          <th>Style</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Carto Voyager</td>
          <td>Colorful, detailed</td>
          <td>Best for the full trip overview — road hierarchy clear, cities labeled, not overloaded</td>
        </tr>
        <tr>
          <td>Carto Dark Matter</td>
          <td>Dark, bold</td>
          <td>Good for speed heatmap — dark base lets colored segments read clearly; loses road detail at zoom 5–6</td>
        </tr>
        <tr>
          <td>Carto Positron</td>
          <td>Minimal, light</td>
          <td>Clean but low contrast on the colored elevation tracks</td>
        </tr>
        <tr>
          <td>OpenTopoMap</td>
          <td>Terrain + contour</td>
          <td>Beautiful for mountain days but too busy across the flat South</td>
        </tr>
        <tr>
          <td>Stadia Watercolor</td>
          <td>Painted texture</td>
          <td>Visually striking but slow tile server; Stadia no longer rotates subdomains — omit <code>&#123;s&#125;</code></td>
        </tr>
        <tr>
          <td>Stadia Toner</td>
          <td>High-contrast B&amp;W</td>
          <td>Punchy, works for data overlays; same subdomain note</td>
        </tr>
        <tr>
          <td>ESRI NatGeo</td>
          <td>Atlas reference</td>
          <td>Matches the site's aesthetic but ESRI doesn't support subdomain rotation</td>
        </tr>
        <tr>
          <td>ESRI Satellite</td>
          <td>Aerial imagery</td>
          <td>Too literal for a narrative map</td>
        </tr>
      </tbody>
    </table>
    <div class="callout">
      <p>
        <strong>Final choices:</strong> Carto Voyager for the full trip overview and linked elevation view. Carto Dark Matter for the speed painting experiment. The ridge plot and elevation profiles have no map at all — the geographic context of the tile layer isn't needed when the data is already telling the story.
      </p>
    </div>
  </div>

  <!-- ── DATA VIZ LIBRARY ── -->
  <div class="tech-section">
    <div class="section-label">04 —</div>
    <h2 class="section-title">D3 for Data Visualization</h2>
    <p>
      When the goal moved from "show the route" to "show the elevation" and "show the ridge," Leaflet stopped being the right tool. D3 v7 UMD was chosen for all SVG-based visualization.
    </p>
    <table class="decision-table">
      <thead>
        <tr>
          <th>Library</th>
          <th>CDN size</th>
          <th>Verdict</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>D3 v7 (UMD)</td>
          <td>580 KB</td>
          <td class="verdict-yes">Used</td>
          <td>Full control over SVG paths, scales, and layouts. UMD build sets <code>window.d3</code> — works with <code>is:inline</code></td>
        </tr>
        <tr>
          <td>Observable Plot 0.6</td>
          <td>280 KB</td>
          <td class="verdict-no">Skipped</td>
          <td>Good declarative API for standard charts; not flexible enough for the ridge plot's custom rendering order</td>
        </tr>
        <tr>
          <td>Chart.js</td>
          <td>200 KB</td>
          <td class="verdict-no">Skipped</td>
          <td>Canvas-based, good for standard charts, no direct SVG path control</td>
        </tr>
        <tr>
          <td>Plotly.js</td>
          <td>3.5 MB</td>
          <td class="verdict-no">Skipped</td>
          <td>Too large for CDN use on a static site</td>
        </tr>
        <tr>
          <td>Three.js r170</td>
          <td>650 KB</td>
          <td class="verdict-no">Future</td>
          <td>3D ribbon visualization is possible but complexity is high — build last</td>
        </tr>
      </tbody>
    </table>
    <p>
      D3's area generator and scale system made the ridge plot tractable. The key operations — <code>d3.area()</code> with <code>y0</code>/<code>y1</code>, <code>d3.scaleLinear()</code>, <code>d3.bisectLeft()</code> for hover — are well-matched to what the visualizations actually need.
    </p>
  </div>

  <!-- ── DATA PIPELINE ── -->
  <div class="tech-section">
    <div class="section-label">05 —</div>
    <h2 class="section-title">The GPX Data Pipeline</h2>
    <p>
      Raw Garmin GPX exports contain ~58,000 points across 9 days — about 6,400 per day average, with Day 4 and Day 8 running to 14,000+. Rendering 6,400 SVG path segments per elevation profile is too slow; rendering them all at once for a ridge plot or animation is unusable. The pipeline reduces this without losing the visual signal.
    </p>
    <div class="pipeline">
      <div class="pipeline-step">
        <div class="step-num">01</div>
        <div class="step-body">
          <div class="step-name">Parse</div>
          <p class="step-desc"><code>fetch(url)</code> → <code>DOMParser</code> → <code>querySelectorAll('trkpt')</code>. Each point: <code>&#123;lat, lon, ele, time&#125;</code>. No library needed for this step.</p>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="step-num">02</div>
        <div class="step-body">
          <div class="step-name">Smooth elevation</div>
          <p class="step-desc">5–6 point symmetric rolling average on raw elevation values. Garmin records via GPS receiver, not barometric — urban segments are noisy. Smoothing before downsampling ensures LTTB works from clean data. Days 1–2 had GPS drift producing negative elevations on flat coastal roads; smoothing tames these without losing the genuine signal.</p>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="step-num">03</div>
        <div class="step-body">
          <div class="step-name">Stride sample</div>
          <p class="step-desc">For the basic charts, every 6th–8th point is taken. Fast, sufficient for profile shape. For the ridge plot this produces ~400–600 points per day.</p>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="step-num">04</div>
        <div class="step-body">
          <div class="step-name">LTTB downsample</div>
          <p class="step-desc"><strong>Largest Triangle Three Buckets</strong> — for the linked elevation profiles where accuracy matters. Divides the data into N equal buckets; in each bucket selects the point that maximizes the area of the triangle formed with the previously selected point and the average of the next bucket. Peaks, valleys, and inflection points are always preserved. Reduces 14,000 points to 480 with minimal visible distortion. ~40 lines of pure JS, no CDN needed.</p>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="step-num">05</div>
        <div class="step-body">
          <div class="step-name">Build distance series</div>
          <p class="step-desc">Haversine formula accumulates distance between sampled points. Output: <code>&#123;dist, ele, lat, lon&#125;</code> per point. The <code>dist</code> value is cumulative miles from the start of the day — this is the x-axis for every elevation chart.</p>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="step-num">06</div>
        <div class="step-body">
          <div class="step-name">Zero-baseline (ridge only)</div>
          <p class="step-desc">Subtract each day's starting elevation so every ridge begins at 0. This makes the shape (the change) readable rather than the absolute altitude. Day 1 starts near sea level; Day 6 starts at 3,800 ft in Terlingua. A global scale is meaningless without this step — every day would just be a flat line at its absolute elevation.</p>
        </div>
      </div>
    </div>
    <div class="callout">
      <p>
        <strong>Known data anomalies:</strong> Days 1 and 4 contain GPS glitch points near −47m — multipath errors near highway overpasses. The Salton Sea (Day 9) has 115 genuine below-sea-level points; that's real, not noise. The speed heatmap caps at 90 mph to filter the remaining glitches.
      </p>
    </div>
  </div>

  <!-- ── RIDGE PLOT ── -->
  <div class="tech-section">
    <div class="section-label">06 —</div>
    <h2 class="section-title">The Ridge Plot — Two Bugs Worth Noting</h2>
    <p>
      The ridge plot (Joy Division / <em>Unknown Pleasures</em> style) had two non-obvious implementation bugs that are worth recording.
    </p>
    <p>
      <strong>Bug 1: background fill covering everything.</strong> Each row needs a background-color fill from its ridge line down to its baseline, so that taller rows behind it don't bleed into its space. The initial version used <code>y0 = SVG_H</code> — filling all the way to the bottom of the SVG. Day 1 (rendered last, on top) had a nearly-flat ridge near y=138. Its fill covered everything below y=138, hiding all 8 other days. Fix: <code>y0 = baseline</code>. The fill now only covers this row's own elevation window. Taller rows behind it remain visible where they rise above the current baseline — which is exactly the intended effect.
    </p>
    <p>
      <strong>Bug 2: scale zero-point drift.</strong> A single linear scale over <code>[globalMinDrop, globalMaxGain]</code> doesn't anchor 0 at the baseline unless both extremes are equal in magnitude. Day 5 climbs ~4,900 ft above its start; Day 9 drops ~2,630 ft below its start. A single scale maps 0 to ~20px above baseline — flat days appear visibly elevated. Fix: two separate linear scales, both anchored at zero. One for positive elevation (0→PEAK_PX), one for negative (0→−BELOW_PX). Flat days sit exactly at their baselines.
    </p>
  </div>

  <!-- ── PAGES ── -->
  <div class="tech-section">
    <div class="section-label">07 —</div>
    <h2 class="section-title">What Was Built</h2>
    <table class="decision-table">
      <thead>
        <tr>
          <th>Page</th>
          <th>Libraries</th>
          <th>What it shows</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Full Trip</td>
          <td>Leaflet + leaflet-gpx</td>
          <td>All 9 days on Carto Voyager. Each day its theme color. Hover/click interaction between tracks and sidebar legend.</td>
        </tr>
        <tr>
          <td>Elevation</td>
          <td>Leaflet + D3 v7</td>
          <td>Split view: map left, 9 scrollable D3 profile cards right. Hovering a profile moves a crosshair marker on the map. Clicking a track highlights the card.</td>
        </tr>
        <tr>
          <td>Experiments</td>
          <td>Leaflet + D3 v7</td>
          <td>Three experiments: speed heatmap (color by mph bucket), SVG elevation profiles (pre-D3 version), animated replay with truck icon and speed modes.</td>
        </tr>
        <tr>
          <td>The Ridge</td>
          <td>D3 v7 only</td>
          <td>Stacked elevation ridgelines, Joy Division style. No map — the data is the visualization. Zero-baselined, global y-scale, bottom-to-top render order.</td>
        </tr>
      </tbody>
    </table>
  </div>

</div><!-- /tech-body -->

</body>
</html>
