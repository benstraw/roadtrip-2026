---
import MapNav from '../components/MapNav.astro';
import Analytics from '@vercel/analytics/astro';
---
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiments — The Road</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Raleway:wght@400;600&family=Space+Mono:wght@400;700&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0c1420; --bg-deep: #07101a; --surface: #111e30;
      --accent: #c8a84a; --text: #e8e0d0; --text-muted: #8a7e6a; --border: #1e2e40;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Raleway', system-ui, sans-serif; }

    /* ─── HEADER ── */
    .page-header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap; }
    .page-header h1 { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent); }
    .page-header .subtitle { font-size: 0.65rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-muted); }

    /* ─── SECTION TEMPLATE ── */
    .section { max-width: 1200px; margin: 0 auto; padding: 3rem 1.5rem; border-bottom: 1px solid var(--border); }
    .section-header { margin-bottom: 1.5rem; }
    .section-num { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: var(--accent); letter-spacing: 0.1em; }
    .section-title { font-family: 'Playfair Display', serif; font-size: clamp(1.4rem, 3vw, 1.9rem); color: var(--text); margin: 0.25rem 0 0.5rem; }
    .section-desc { font-size: 0.8rem; color: var(--text-muted); max-width: 560px; line-height: 1.6; }

    /* ─── EXPERIMENT WRAPPER ── */
    .exp-box { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
    .map-container { height: 500px; width: 100%; }

    /* ─── SPEED LEGEND ── */
    .speed-legend {
      display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;
      padding: 0.75rem 1rem; border-top: 1px solid var(--border);
      font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted);
    }
    .legend-item { display: flex; align-items: center; gap: 0.35rem; }
    .legend-swatch { width: 20px; height: 4px; border-radius: 2px; }

    /* ─── ELEVATION GRID ── */
    .elev-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1px;
      background: var(--border);
    }
    .elev-cell {
      background: var(--bg-deep);
      padding: 1rem;
    }
    .elev-cell-header { display: flex; align-items: baseline; gap: 0.6rem; margin-bottom: 0.6rem; }
    .elev-day-num { font-family: 'Space Mono', monospace; font-size: 0.7rem; font-weight: 700; }
    .elev-day-route { font-size: 0.7rem; color: var(--text-muted); }
    .elev-chart { width: 100%; height: 80px; }
    .elev-stats { display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); }
    .elev-stats span { font-family: 'Space Mono', monospace; }

    /* ─── REPLAY ── */
    .replay-controls {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border);
      display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;
    }
    .replay-btn {
      font-family: 'Space Mono', monospace; font-size: 0.7rem; font-weight: 700;
      padding: 0.4rem 0.9rem; border: 1px solid var(--border); border-radius: 3px;
      background: var(--bg-deep); color: var(--text); cursor: pointer; letter-spacing: 0.06em;
      transition: all 0.15s;
    }
    .replay-btn:hover { border-color: var(--accent); color: var(--accent); }
    .replay-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .replay-info { flex: 1; }
    .replay-day-label { font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; color: var(--accent); }
    .replay-time-label { font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; }
    .replay-progress { flex: 1; min-width: 200px; }
    .replay-progress-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 0.3rem; overflow: hidden; }
    .replay-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }

    /* ─── LEAFLET OVERRIDES ── */
    .leaflet-popup-content-wrapper { background: var(--surface) !important; color: var(--text) !important; border: 1px solid var(--border) !important; border-radius: 4px !important; font-family: 'Raleway', sans-serif !important; font-size: 0.8rem !important; box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important; }
    .leaflet-popup-tip { background: var(--surface) !important; }
    .leaflet-popup-content strong { color: var(--accent); font-family: 'Space Mono', monospace; font-size: 0.75rem; display: block; margin-bottom: 0.2rem; }

    @media (max-width: 600px) { .map-container { height: 350px; } }
  </style>
</head>
<body>

<header class="page-header">
  <h1>Experiments</h1>
  <span class="subtitle">Speed · Elevation · Replay</span>
  <MapNav current="experiments" />
</header>

<!-- ══════════════════════════════════════════════════════════════════════════ -->
<!-- EXPERIMENT A: SPEED PAINTING                                              -->
<!-- ══════════════════════════════════════════════════════════════════════════ -->
<section class="section">
  <div class="section-header">
    <div class="section-num">A —</div>
    <h2 class="section-title">Speed Painting</h2>
    <p class="section-desc">Every GPS point colored by speed. Gray means stopped. Blue is city driving. Orange is secondary roads. Red is highway. You can see the interstate corridors, the Texas back roads, the crawl through Big Bend.</p>
  </div>
  <div class="exp-box">
    <div id="map-speed" class="map-container"></div>
    <div class="speed-legend">
      <span style="color:var(--text-muted)">Speed:</span>
      <div class="legend-item"><div class="legend-swatch" style="background:#444"></div> Stopped (&lt;5 mph)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#3a86ff"></div> City (5–35)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#ff9f1c"></div> Secondary (35–60)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#e63946"></div> Highway (60+)</div>
      <div class="legend-item" style="margin-left:auto; font-size:0.6rem; color:var(--text-muted);" id="speed-status">Loading tracks…</div>
    </div>
  </div>
</section>

<!-- ══════════════════════════════════════════════════════════════════════════ -->
<!-- EXPERIMENT B: ELEVATION PROFILES                                          -->
<!-- ══════════════════════════════════════════════════════════════════════════ -->
<section class="section">
  <div class="section-header">
    <div class="section-num">B —</div>
    <h2 class="section-title">The Profile</h2>
    <p class="section-desc">Elevation over distance for every day. The flatlands of the South. The climb into the Appalachians. The Big Bend basin. The rise into New Mexico. The drop into the Sonoran. Nine silhouettes.</p>
  </div>
  <div class="exp-box">
    <div class="elev-grid" id="elev-grid"></div>
  </div>
</section>

<!-- ══════════════════════════════════════════════════════════════════════════ -->
<!-- EXPERIMENT C: TRIP REPLAY                                                 -->
<!-- ══════════════════════════════════════════════════════════════════════════ -->
<section class="section">
  <div class="section-header">
    <div class="section-num">C —</div>
    <h2 class="section-title">Replay</h2>
    <p class="section-desc">Watch the whole trip drive itself. 9 days compressed into a few minutes. The line draws. The truck moves. Philadelphia to California.</p>
  </div>
  <div class="exp-box">
    <div id="map-replay" class="map-container"></div>
    <div class="replay-controls">
      <button class="replay-btn" id="replay-play">▶ Play</button>
      <button class="replay-btn" id="replay-reset">↺ Reset</button>
      <div class="replay-info">
        <div class="replay-day-label" id="replay-day-label">Ready</div>
        <div class="replay-time-label" id="replay-time-label">Press play to begin</div>
      </div>
      <div class="replay-progress">
        <div class="replay-progress-bar"><div class="replay-progress-fill" id="replay-progress-fill"></div></div>
      </div>
      <button class="replay-btn" id="replay-snap" title="Follow the truck">⊙ Snap</button>
      <div style="display:flex;gap:0.4rem;flex-shrink:0;">
        <button class="replay-btn speed-btn" data-pts="1">Smooth</button>
        <button class="replay-btn speed-btn active" data-pts="5">Fast</button>
        <button class="replay-btn speed-btn" data-pts="25">Warp</button>
        <button class="replay-btn speed-btn" data-pts="0">Instant</button>
      </div>
    </div>
  </div>
</section>

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script is:inline>

const DAYS = [
  { day: 1, from: 'Philadelphia', to: 'Charlotte',  miles: 536, gpx: '/maps/Day 1 - Philly to Charlotte.gpx',            color: '#7ebcd6', date: 'Jan 30', tagline: 'Dig out. Point south.' },
  { day: 2, from: 'Charlotte',    to: 'Montgomery',  miles: 406, gpx: '/maps/Day 2 - Charlotte NC to Montgomery AL.gpx',   color: '#a0c8e0', date: 'Jan 31', tagline: 'Five a.m. Half an inch.' },
  { day: 3, from: 'Montgomery',   to: 'Jackson',     miles: 186, gpx: '/maps/Day 3 - Montgomery AL to Jackson MS.gpx',     color: '#c4782a', date: 'Feb 1',  tagline: 'Heavier ground.' },
  { day: 4, from: 'Jackson',      to: 'Austin',      miles: 480, gpx: '/maps/Day 4 - Jackson MS to Austin TX.gpx',         color: '#d4761e', date: 'Feb 2',  tagline: 'Texas opens up.' },
  { day: 5, from: 'Austin',       to: 'Terlingua',   miles: 330, gpx: '/maps/Day 5 - Austin TX to Terilingua TX.gpx',      color: '#e8681a', date: 'Feb 3',  tagline: 'Nothing for miles.' },
  { day: 6, from: 'Terlingua',    to: 'Big Bend',    miles: 62,  gpx: '/maps/Day 6 - Big Bend National Park.gpx',          color: '#d4481a', date: 'Feb 4',  tagline: 'Into the canyon.' },
  { day: 7, from: 'Big Bend',     to: 'Big Bend',    miles: 55,  gpx: '/maps/Day 7 - Big Bend National Park.gpx',          color: '#c83a0a', date: 'Feb 5',  tagline: 'Santa Elena.' },
  { day: 8, from: 'Terlingua',    to: 'Tucson',      miles: 474, gpx: '/maps/Day 8 - Terilingua TX to Tucson AZ.gpx',      color: '#d4600a', date: 'Feb 6',  tagline: 'Through the Sonoran.' },
  { day: 9, from: 'Tucson',       to: 'California',  miles: 224, gpx: '/maps/Day 9 - Tucson AZ to Los Angeles CA.gpx',     color: '#f5c400', date: 'Feb 7',  tagline: 'Palm trees. Made it.' },
];

// ─── UTILITIES ──────────────────────────────────────────────────────────────

function haversine(lat1, lon1, lat2, lon2) {
  const R = 3958.8;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function speedColor(mph) {
  if (mph < 5)  return '#444';
  if (mph < 35) return '#3a86ff';
  if (mph < 60) return '#ff9f1c';
  return '#e63946';
}

function metersToFeet(m) { return m * 3.28084; }

async function parseGPX(url) {
  const resp = await fetch(url);
  const text = await resp.text();
  const doc = new DOMParser().parseFromString(text, 'application/xml');
  const trkpts = Array.from(doc.querySelectorAll('trkpt'));
  return trkpts.map(pt => ({
    lat: parseFloat(pt.getAttribute('lat')),
    lon: parseFloat(pt.getAttribute('lon')),
    ele: parseFloat(pt.querySelector('ele')?.textContent || '0'),
    time: new Date(pt.querySelector('time')?.textContent || 0),
  }));
}

// ─── A: SPEED MAP ────────────────────────────────────────────────────────────

(async function initSpeedMap() {
  const map = L.map('map-speed', { scrollWheelZoom: false, center: [35, -90], zoom: 5 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO', maxZoom: 18, subdomains: 'abcd',
  }).addTo(map);

  const statusEl = document.getElementById('speed-status');
  let loaded = 0;
  const allBounds = [];

  for (const d of DAYS) {
    const pts = await parseGPX(d.gpx);
    loaded++;
    statusEl.textContent = `${loaded} / 9 loaded`;

    // Sample every 5 points for performance
    const STEP = 5;
    const segments = [];
    for (let i = 0; i < pts.length - STEP; i += STEP) {
      const a = pts[i], b = pts[i + STEP];
      const dist = haversine(a.lat, a.lon, b.lat, b.lon);
      const dtMs = b.time - a.time;
      const mph = dtMs > 0 ? (dist / (dtMs / 3600000)) : 0;
      // cap at 90mph to filter GPS glitches
      const clampedMph = Math.min(mph, 90);
      segments.push({ coords: [[a.lat, a.lon], [b.lat, b.lon]], color: speedColor(clampedMph), mph: clampedMph.toFixed(0) });
    }

    segments.forEach(seg => {
      L.polyline(seg.coords, { color: seg.color, weight: 2.5, opacity: 0.8 }).addTo(map);
    });

    const bounds = L.latLngBounds(pts.map(p => [p.lat, p.lon]));
    allBounds.push(bounds);

    if (loaded === DAYS.length) {
      const combined = allBounds.reduce((acc, b) => acc.extend(b));
      map.fitBounds(combined, { padding: [30, 30] });
      statusEl.textContent = '9 / 9 — all tracks loaded';
    }
  }
})();

// ─── B: ELEVATION PROFILES ──────────────────────────────────────────────────

(async function initElevation() {
  const grid = document.getElementById('elev-grid');

  for (const d of DAYS) {
    const cell = document.createElement('div');
    cell.className = 'elev-cell';
    cell.innerHTML = `
      <div class="elev-cell-header">
        <span class="elev-day-num" style="color:${d.color}">Day ${d.day}</span>
        <span class="elev-day-route">${d.from} → ${d.to}</span>
      </div>
      <svg class="elev-chart" id="elev-svg-${d.day}" viewBox="0 0 280 80" preserveAspectRatio="none"></svg>
      <div class="elev-stats" id="elev-stats-${d.day}">Loading…</div>
    `;
    grid.appendChild(cell);

    const pts = await parseGPX(d.gpx);
    const STEP = 8;
    const sampled = pts.filter((_, i) => i % STEP === 0);

    // Build cumulative distance + elevation series
    let cumDist = 0;
    const series = [];
    for (let i = 0; i < sampled.length; i++) {
      if (i > 0) cumDist += haversine(sampled[i-1].lat, sampled[i-1].lon, sampled[i].lat, sampled[i].lon);
      series.push({ dist: cumDist, ele: metersToFeet(sampled[i].ele) });
    }

    const minEle = Math.min(...series.map(p => p.ele));
    const maxEle = Math.max(...series.map(p => p.ele));
    const totalDist = series[series.length - 1]?.dist || 1;
    const eleRange = maxEle - minEle || 1;

    // SVG path (280×80 viewBox)
    const W = 280, H = 80, PAD = 4;
    const toX = dist => PAD + (dist / totalDist) * (W - PAD * 2);
    const toY = ele => H - PAD - ((ele - minEle) / eleRange) * (H - PAD * 2);

    const pts2 = series.map(p => `${toX(p.dist).toFixed(1)},${toY(p.ele).toFixed(1)}`).join(' ');
    const areaPath = `M${toX(0)},${H} L${pts2.replace(/(\d+\.?\d*),(\d+\.?\d*)/g, '$1,$2 ')} L${toX(totalDist)},${H} Z`;

    const svg = document.getElementById(`elev-svg-${d.day}`);
    svg.innerHTML = `
      <defs>
        <linearGradient id="grad-${d.day}" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${d.color}" stop-opacity="0.6"/>
          <stop offset="100%" stop-color="${d.color}" stop-opacity="0.08"/>
        </linearGradient>
      </defs>
      <path d="${areaPath}" fill="url(#grad-${d.day})"/>
      <polyline points="${pts2}" fill="none" stroke="${d.color}" stroke-width="1.2" stroke-linejoin="round"/>
    `;

    const statsEl = document.getElementById(`elev-stats-${d.day}`);
    statsEl.innerHTML = `
      <div>Min: <span>${Math.round(minEle).toLocaleString()} ft</span></div>
      <div>Max: <span>${Math.round(maxEle).toLocaleString()} ft</span></div>
      <div>Gain: <span>+${Math.round(maxEle - minEle).toLocaleString()} ft</span></div>
      <div>Dist: <span>${totalDist.toFixed(0)} mi</span></div>
    `;
  }
})();

// ─── C: REPLAY ──────────────────────────────────────────────────────────────

(async function initReplay() {
  const map = L.map('map-replay', { scrollWheelZoom: false, center: [35, -95], zoom: 4 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO', maxZoom: 18, subdomains: 'abcd',
  }).addTo(map);

  const playBtn    = document.getElementById('replay-play');
  const resetBtn   = document.getElementById('replay-reset');
  const dayLabel   = document.getElementById('replay-day-label');
  const timeLabel  = document.getElementById('replay-time-label');
  const progressFill = document.getElementById('replay-progress-fill');
  const speedBtns  = document.querySelectorAll('.speed-btn');

  // ── speed state ──
  let ptsPerFrame = 5; // default: Fast
  speedBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      speedBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ptsPerFrame = parseInt(btn.dataset.pts, 10);
    });
  });

  // ── load & pre-sample all tracks ──
  dayLabel.textContent = 'Loading tracks…';
  timeLabel.textContent = 'Please wait';

  const MAX_PER_DAY = 400;

  // Create one persistent polyline per day (empty to start)
  const lines = {};
  const lineCoords = {};
  DAYS.forEach(d => {
    lines[d.day] = L.polyline([], { color: d.color, weight: 3.5, opacity: 0.9, lineCap: 'round', lineJoin: 'round' }).addTo(map);
    lineCoords[d.day] = [];
  });

  const truckIcon = L.divIcon({
    className: '',
    html: `<svg width="28" height="16" viewBox="0 0 28 16" xmlns="http://www.w3.org/2000/svg" style="filter:drop-shadow(0 1px 3px rgba(0,0,0,0.6))">
      <!-- bed -->
      <rect x="1" y="3" width="11" height="10" rx="1.2" fill="#cc2200" stroke="#8a1500" stroke-width="0.6"/>
      <!-- cab -->
      <rect x="12" y="1.5" width="13" height="13" rx="2" fill="#cc2200" stroke="#8a1500" stroke-width="0.6"/>
      <!-- windshield -->
      <rect x="19" y="4" width="4.5" height="6" rx="1" fill="#b8d8f0" opacity="0.75"/>
      <!-- front bumper -->
      <rect x="24.5" y="4.5" width="2" height="7" rx="0.8" fill="#555"/>
      <!-- bed divider -->
      <line x1="12" y1="3" x2="12" y2="13" stroke="#8a1500" stroke-width="0.8"/>
      <!-- wheels -->
      <rect x="2" y="0"  width="5" height="3.5" rx="1.2" fill="#1a1a1a"/>
      <rect x="2" y="12.5" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/>
      <rect x="8" y="0"  width="5" height="3.5" rx="1.2" fill="#1a1a1a"/>
      <rect x="8" y="12.5" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/>
      <rect x="14" y="0"  width="5" height="3.5" rx="1.2" fill="#1a1a1a"/>
      <rect x="14" y="12.5" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/>
    </svg>`,
    iconSize: [28, 16], iconAnchor: [14, 8],
  });
  const truck = L.marker([39.94, -75.15], { icon: truckIcon }).addTo(map);

  // ── snap toggle ──
  const snapBtn = document.getElementById('replay-snap');
  let snapEnabled = false;
  snapBtn.addEventListener('click', () => {
    snapEnabled = !snapEnabled;
    snapBtn.classList.toggle('active', snapEnabled);
    snapBtn.textContent = snapEnabled ? '⊙ Snapped' : '⊙ Snap';
    if (snapEnabled && truck.getLatLng()) {
      map.setView(truck.getLatLng(), 8, { animate: false });
    } else if (!snapEnabled) {
      map.setView([35, -95], 4, { animate: true });
    }
  });

  // Load, sample, and flatten
  const flatPts = [];
  for (const d of DAYS) {
    const raw = await parseGPX(d.gpx);
    const step = Math.max(1, Math.floor(raw.length / MAX_PER_DAY));
    const sampled = raw.filter((_, i) => i % step === 0 || i === raw.length - 1);
    sampled.forEach(p => flatPts.push({ lat: p.lat, lon: p.lon, day: d.day, color: d.color, date: d.date, from: d.from, to: d.to, tagline: d.tagline }));
  }
  const totalPts = flatPts.length;

  dayLabel.textContent = 'Ready';
  timeLabel.textContent = `${totalPts.toLocaleString()} waypoints loaded — press play`;

  let playing = false;
  let animFrame = null;
  let idx = 0;

  function finish() {
    playing = false;
    cancelAnimationFrame(animFrame);
    playBtn.textContent = '▶ Play';
    playBtn.classList.remove('active');
    dayLabel.textContent = 'Philadelphia → California';
    timeLabel.textContent = '3,753 miles. Done.';
    progressFill.style.width = '100%';
  }

  function resetState() {
    finish();
    idx = 0;
    progressFill.style.width = '0%';
    dayLabel.textContent = 'Ready';
    timeLabel.textContent = 'Press play to begin';
    truck.setLatLng([39.94, -75.15]);
    snapEnabled = false;
    snapBtn.classList.remove('active');
    snapBtn.textContent = '⊙ Snap';
    map.setView([35, -95], 4, { animate: false });
    DAYS.forEach(d => { lineCoords[d.day] = []; lines[d.day].setLatLngs([]); });
  }

  function step() {
    if (!playing) return;

    // Instant mode: draw all at once
    if (ptsPerFrame === 0) {
      flatPts.forEach(pt => {
        lineCoords[pt.day].push([pt.lat, pt.lon]);
        lines[pt.day].setLatLngs(lineCoords[pt.day]);
      });
      idx = totalPts;
      finish();
      return;
    }

    const end = Math.min(idx + ptsPerFrame, totalPts);
    for (let i = idx; i < end; i++) {
      const pt = flatPts[i];
      lineCoords[pt.day].push([pt.lat, pt.lon]);
      // setLatLngs updates the existing layer in place — no remove/recreate
      lines[pt.day].setLatLngs(lineCoords[pt.day]);
    }
    idx = end;

    const cur = flatPts[Math.min(idx, totalPts - 1)];
    truck.setLatLng([cur.lat, cur.lon]);
    if (snapEnabled) map.panTo([cur.lat, cur.lon], { animate: false });
    dayLabel.textContent = `Day ${cur.day} · ${cur.date}`;
    timeLabel.textContent = `${cur.from} → ${cur.to} · ${cur.tagline}`;
    progressFill.style.width = `${(idx / totalPts * 100).toFixed(1)}%`;

    if (idx >= totalPts) { finish(); return; }
    animFrame = requestAnimationFrame(step);
  }

  playBtn.addEventListener('click', () => {
    if (idx >= totalPts) resetState();
    playing = !playing;
    if (playing) {
      playBtn.textContent = '⏸ Pause';
      playBtn.classList.add('active');
      animFrame = requestAnimationFrame(step);
    } else {
      playBtn.textContent = '▶ Play';
      playBtn.classList.remove('active');
      cancelAnimationFrame(animFrame);
    }
  });

  resetBtn.addEventListener('click', resetState);
})();

</script>
<Analytics />
</body>
</html>
