---
import ExperimentPager from '../components/ExperimentPager.astro';
import MapBase from '../layouts/MapBase.astro';
---
<MapBase title="Replay — The Road" leaflet>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root { --bg:#0c1420; --bg-deep:#07101a; --surface:#111e30; --accent:#c8a84a; --text:#e8e0d0; --text-muted:#8a7e6a; --border:#1e2e40; }
  body { background: var(--bg); color: var(--text); font-family: 'Raleway', system-ui, sans-serif; }

  .page-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
  .back-link { font-family: 'Space Mono', monospace; font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); text-decoration: none; }
  .back-link:hover { color: var(--accent); }
  h1 { font-family: 'Playfair Display', serif; font-size: 1.05rem; color: var(--accent); }

  .body { max-width: 1200px; margin: 0 auto; padding: 1.25rem; }
  .desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 0.9rem; }
  .exp-box { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
  #map-replay { height: 560px; width: 100%; }
  .replay-controls { padding: 0.75rem 1rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
  .replay-btn { font-family: 'Space Mono', monospace; font-size: 0.7rem; font-weight: 700; padding: 0.4rem 0.9rem; border: 1px solid var(--border); border-radius: 3px; background: var(--bg-deep); color: var(--text); cursor: pointer; letter-spacing: 0.06em; transition: all 0.15s; }
  .replay-btn:hover { border-color: var(--accent); color: var(--accent); }
  .replay-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .replay-info { flex: 1; }
  .replay-day-label { font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; color: var(--accent); }
  .replay-time-label { font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; }
  .replay-progress { flex: 1; min-width: 200px; }
  .replay-progress-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 0.3rem; overflow: hidden; }
  .replay-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }
  @media (max-width: 700px) { #map-replay { height: 420px; } }
</style>

<header class="page-header">
  <a href="/" class="back-link">← Back to Trip</a>
  <h1>Replay</h1>
</header>
<div class="body" style="padding-bottom:0.6rem;">
  <ExperimentPager current="/mapexp-replay" />
</div>

<div class="body">
  <p class="desc">Watch the full trip draw itself. Set speed, toggle snap-follow, and run the entire route coast to coast.</p>
  <div class="exp-box">
    <div id="map-replay"></div>
    <div class="replay-controls">
      <button class="replay-btn" id="replay-play">▶ Play</button>
      <button class="replay-btn" id="replay-reset">↺ Reset</button>
      <div class="replay-info">
        <div class="replay-day-label" id="replay-day-label">Ready</div>
        <div class="replay-time-label" id="replay-time-label">Press play to begin</div>
      </div>
      <div class="replay-progress"><div class="replay-progress-bar"><div class="replay-progress-fill" id="replay-progress-fill"></div></div></div>
      <button class="replay-btn" id="replay-snap" title="Follow the truck">⊙ Snap</button>
      <div style="display:flex;gap:0.4rem;flex-shrink:0;">
        <button class="replay-btn speed-btn" data-pts="1">Smooth</button>
        <button class="replay-btn speed-btn active" data-pts="5">Fast</button>
        <button class="replay-btn speed-btn" data-pts="25">Warp</button>
        <button class="replay-btn speed-btn" data-pts="0">Instant</button>
      </div>
    </div>
  </div>
</div>

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script is:inline>
const DAYS = [
  { day: 1, from: 'Philadelphia', to: 'Charlotte',  gpx: '/maps/Day 1 - Philly to Charlotte.gpx',          color: '#7ebcd6', date: 'Jan 30', tagline: 'Dig out. Point south.' },
  { day: 2, from: 'Charlotte',    to: 'Montgomery', gpx: '/maps/Day 2 - Charlotte NC to Montgomery AL.gpx', color: '#a0c8e0', date: 'Jan 31', tagline: 'Five a.m. Half an inch.' },
  { day: 3, from: 'Montgomery',   to: 'Jackson',    gpx: '/maps/Day 3 - Montgomery AL to Jackson MS.gpx',   color: '#c4782a', date: 'Feb 1', tagline: 'Heavier ground.' },
  { day: 4, from: 'Jackson',      to: 'Austin',     gpx: '/maps/Day 4 - Jackson MS to Austin TX.gpx',       color: '#d4761e', date: 'Feb 2', tagline: 'Texas opens up.' },
  { day: 5, from: 'Austin',       to: 'Terlingua',  gpx: '/maps/Day 5 - Austin TX to Terilingua TX.gpx',    color: '#e8681a', date: 'Feb 3', tagline: 'Nothing for miles.' },
  { day: 6, from: 'Terlingua',    to: 'Big Bend',   gpx: '/maps/Day 6 - Big Bend National Park.gpx',        color: '#d4481a', date: 'Feb 4', tagline: 'Into the canyon.' },
  { day: 7, from: 'Big Bend',     to: 'Big Bend',   gpx: '/maps/Day 7 - Big Bend National Park.gpx',        color: '#c83a0a', date: 'Feb 5', tagline: 'Santa Elena.' },
  { day: 8, from: 'Terlingua',    to: 'Tucson',     gpx: '/maps/Day 8 - Terilingua TX to Tucson AZ.gpx',    color: '#d4600a', date: 'Feb 6', tagline: 'Through the Sonoran.' },
  { day: 9, from: 'Tucson',       to: 'California', gpx: '/maps/Day 9 - Tucson AZ to Los Angeles CA.gpx',   color: '#f5c400', date: 'Feb 7', tagline: 'Palm trees. Made it.' },
];
async function parseGPX(url) {
  const resp = await fetch(url);
  const text = await resp.text();
  const doc = new DOMParser().parseFromString(text, 'application/xml');
  const trkpts = Array.from(doc.querySelectorAll('trkpt'));
  return trkpts.map(pt => ({ lat: parseFloat(pt.getAttribute('lat')), lon: parseFloat(pt.getAttribute('lon')) }));
}

(async function initReplay() {
  const map = L.map('map-replay', { scrollWheelZoom: false, center: [35, -95], zoom: 4 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap contributors &copy; CARTO', maxZoom: 18, subdomains: 'abcd' }).addTo(map);
  const playBtn = document.getElementById('replay-play');
  const resetBtn = document.getElementById('replay-reset');
  const dayLabel = document.getElementById('replay-day-label');
  const timeLabel = document.getElementById('replay-time-label');
  const progressFill = document.getElementById('replay-progress-fill');
  const speedBtns = document.querySelectorAll('.speed-btn');
  let ptsPerFrame = 5;
  speedBtns.forEach(btn => btn.addEventListener('click', () => { speedBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); ptsPerFrame = parseInt(btn.dataset.pts, 10); }));
  dayLabel.textContent = 'Loading tracks…';
  timeLabel.textContent = 'Please wait';
  const MAX_PER_DAY = 400;
  const lines = {};
  const lineCoords = {};
  DAYS.forEach(d => { lines[d.day] = L.polyline([], { color: d.color, weight: 3.5, opacity: 0.9, lineCap: 'round', lineJoin: 'round' }).addTo(map); lineCoords[d.day] = []; });
  const truck = L.marker([39.94, -75.15], { icon: L.divIcon({ className: '', html: '<svg width="28" height="16" viewBox="0 0 28 16" xmlns="http://www.w3.org/2000/svg" style="filter:drop-shadow(0 1px 3px rgba(0,0,0,0.6))"><rect x="1" y="3" width="11" height="10" rx="1.2" fill="#cc2200" stroke="#8a1500" stroke-width="0.6"/><rect x="12" y="1.5" width="13" height="13" rx="2" fill="#cc2200" stroke="#8a1500" stroke-width="0.6"/><rect x="19" y="4" width="4.5" height="6" rx="1" fill="#b8d8f0" opacity="0.75"/><rect x="24.5" y="4.5" width="2" height="7" rx="0.8" fill="#555"/><line x1="12" y1="3" x2="12" y2="13" stroke="#8a1500" stroke-width="0.8"/><rect x="2" y="0" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/><rect x="2" y="12.5" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/><rect x="8" y="0" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/><rect x="8" y="12.5" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/><rect x="14" y="0" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/><rect x="14" y="12.5" width="5" height="3.5" rx="1.2" fill="#1a1a1a"/></svg>', iconSize: [28, 16], iconAnchor: [14, 8] }) }).addTo(map);
  const snapBtn = document.getElementById('replay-snap');
  let snapEnabled = false;
  snapBtn.addEventListener('click', () => {
    snapEnabled = !snapEnabled;
    snapBtn.classList.toggle('active', snapEnabled);
    snapBtn.textContent = snapEnabled ? '⊙ Snapped' : '⊙ Snap';
    if (snapEnabled && truck.getLatLng()) map.setView(truck.getLatLng(), 8, { animate: false });
    else if (!snapEnabled) map.setView([35, -95], 4, { animate: true });
  });
  const flatPts = [];
  for (const d of DAYS) {
    const raw = await parseGPX(d.gpx);
    const step = Math.max(1, Math.floor(raw.length / MAX_PER_DAY));
    raw.filter((_, i) => i % step === 0 || i === raw.length - 1).forEach(p => flatPts.push({ lat: p.lat, lon: p.lon, day: d.day, date: d.date, from: d.from, to: d.to, tagline: d.tagline }));
  }
  const totalPts = flatPts.length;
  dayLabel.textContent = 'Ready';
  timeLabel.textContent = `${totalPts.toLocaleString()} waypoints loaded — press play`;
  let playing = false;
  let animFrame = null;
  let idx = 0;
  function finish() { playing = false; cancelAnimationFrame(animFrame); playBtn.textContent = '▶ Play'; playBtn.classList.remove('active'); dayLabel.textContent = 'Philadelphia → California'; timeLabel.textContent = '3,753 miles. Done.'; progressFill.style.width = '100%'; }
  function resetState() {
    finish();
    idx = 0;
    progressFill.style.width = '0%';
    dayLabel.textContent = 'Ready';
    timeLabel.textContent = 'Press play to begin';
    truck.setLatLng([39.94, -75.15]);
    snapEnabled = false;
    snapBtn.classList.remove('active');
    snapBtn.textContent = '⊙ Snap';
    map.setView([35, -95], 4, { animate: false });
    DAYS.forEach(d => { lineCoords[d.day] = []; lines[d.day].setLatLngs([]); });
  }
  function step() {
    if (!playing) return;
    if (ptsPerFrame === 0) { flatPts.forEach(pt => { lineCoords[pt.day].push([pt.lat, pt.lon]); lines[pt.day].setLatLngs(lineCoords[pt.day]); }); idx = totalPts; finish(); return; }
    const end = Math.min(idx + ptsPerFrame, totalPts);
    for (let i = idx; i < end; i++) { const pt = flatPts[i]; lineCoords[pt.day].push([pt.lat, pt.lon]); lines[pt.day].setLatLngs(lineCoords[pt.day]); }
    idx = end;
    const cur = flatPts[Math.min(idx, totalPts - 1)];
    truck.setLatLng([cur.lat, cur.lon]);
    if (snapEnabled) map.panTo([cur.lat, cur.lon], { animate: false });
    dayLabel.textContent = `Day ${cur.day} · ${cur.date}`;
    timeLabel.textContent = `${cur.from} → ${cur.to} · ${cur.tagline}`;
    progressFill.style.width = `${(idx / totalPts * 100).toFixed(1)}%`;
    if (idx >= totalPts) { finish(); return; }
    animFrame = requestAnimationFrame(step);
  }
  playBtn.addEventListener('click', () => { if (idx >= totalPts) resetState(); playing = !playing; if (playing) { playBtn.textContent = '⏸ Pause'; playBtn.classList.add('active'); animFrame = requestAnimationFrame(step); } else { playBtn.textContent = '▶ Play'; playBtn.classList.remove('active'); cancelAnimationFrame(animFrame); } });
  resetBtn.addEventListener('click', resetState);
})();
</script>
</MapBase>
