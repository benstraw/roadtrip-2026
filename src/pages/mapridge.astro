---
import MapNav from '../components/MapNav.astro';
import MapBase from '../layouts/MapBase.astro';
---
<MapBase title="The Ridge — The Road">
<style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #05090f; --bg-deep: #030609; --surface: #0a1018;
      --accent: #c8a84a; --text: #e8e0d0; --text-muted: #5a5248; --border: #12181f;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Raleway', system-ui, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

    /* ─── HEADER ─── */
    .page-header {
      padding: 1.25rem 2rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;
    }
    .page-header h1 { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent); }
    .page-header .subtitle { font-size: 0.65rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-muted); }

    /* ─── RIDGE STAGE ─── */
    .ridge-stage { flex: 1; display: flex; flex-direction: column; align-items: stretch; padding: 2rem 0 0; }
    #ridge-svg { display: block; width: 100%; }

    /* ─── CAPTION ─── */
    .ridge-caption {
      max-width: 660px; margin: 0 auto; padding: 2rem 2rem 3rem;
      text-align: center;
      font-size: 0.72rem; letter-spacing: 0.08em; line-height: 1.7;
      color: var(--text-muted);
    }
    .ridge-caption strong { color: var(--accent); font-family: 'Space Mono', monospace; font-size: 0.68rem; }

    /* ─── LOADING ─── */
    #ridge-loading {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 1rem; padding: 4rem;
    }
    .loading-track { width: 300px; height: 2px; background: var(--border); border-radius: 2px; }
    .loading-track-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; border-radius: 2px; }
    .loading-label { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.1em; }

    @media (max-width: 600px) { .ridge-stage { padding: 1rem 0 0; } }
  </style>

<header class="page-header">
  <h1>The Ridge</h1>
  <span class="subtitle">Elevation across 3,753 miles</span>
  <MapNav current="ridge" />
</header>

<div class="ridge-stage">
  <div id="ridge-loading">
    <div class="loading-label" id="loading-label">Loading tracks…</div>
    <div class="loading-track"><div class="loading-track-fill" id="loading-fill"></div></div>
  </div>
  <svg id="ridge-svg" style="display:none"></svg>
  <div class="ridge-caption" id="ridge-caption" style="display:none">
    Nine days. Each ridgeline is one day's elevation, zero-baselined from its start.<br>
    The x-axis is the actual trip — 3,753 miles from
    <strong>Philadelphia</strong> to <strong>California</strong>.<br><br>
    Days 1–4 are flat. The South, the Gulf plain, the Texas plateau.<br>
    Day 5 climbs. Austin to Terlingua: through the Hill Country, over Paisano Pass at <strong>5,406 ft</strong>.<br>
    Days 6 and 7 stay high — the Chisos Basin, Big Bend, <strong>5,764 ft</strong> above sea level.<br>
    Day 8 descends across the Sonoran. Day 9 drops below sea level at the Salton Sea, <strong>−61 ft</strong>, then ends at the Pacific.
  </div>
</div>

<script is:inline src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
<script is:inline>

const DAYS = [
  { day: 1, from: 'Philadelphia', to: 'Charlotte',  miles: 536, gpx: '/maps/Day 1 - Philly to Charlotte.gpx',            color: '#7ebcd6', date: 'Jan 30' },
  { day: 2, from: 'Charlotte',    to: 'Montgomery',  miles: 406, gpx: '/maps/Day 2 - Charlotte NC to Montgomery AL.gpx',   color: '#a0c8e0', date: 'Jan 31' },
  { day: 3, from: 'Montgomery',   to: 'Jackson',     miles: 186, gpx: '/maps/Day 3 - Montgomery AL to Jackson MS.gpx',     color: '#c4782a', date: 'Feb 1'  },
  { day: 4, from: 'Jackson',      to: 'Austin',      miles: 480, gpx: '/maps/Day 4 - Jackson MS to Austin TX.gpx',         color: '#d4761e', date: 'Feb 2'  },
  { day: 5, from: 'Austin',       to: 'Terlingua',   miles: 330, gpx: '/maps/Day 5 - Austin TX to Terilingua TX.gpx',      color: '#e8681a', date: 'Feb 3'  },
  { day: 6, from: 'Terlingua',    to: 'Big Bend',    miles:  62, gpx: '/maps/Day 6 - Big Bend National Park.gpx',          color: '#d4481a', date: 'Feb 4'  },
  { day: 7, from: 'Big Bend',     to: 'Big Bend',    miles:  55, gpx: '/maps/Day 7 - Big Bend National Park.gpx',          color: '#c83a0a', date: 'Feb 5'  },
  { day: 8, from: 'Terlingua',    to: 'Tucson',      miles: 474, gpx: '/maps/Day 8 - Terilingua TX to Tucson AZ.gpx',      color: '#d4600a', date: 'Feb 6'  },
  { day: 9, from: 'Tucson',       to: 'California',  miles: 224, gpx: '/maps/Day 9 - Tucson AZ to Los Angeles CA.gpx',     color: '#f5c400', date: 'Feb 7'  },
];

// ─── UTILITIES ───────────────────────────────────────────────────────────────

function haversine(lat1, lon1, lat2, lon2) {
  const R = 3958.8;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function metersToFeet(m) { return m * 3.28084; }

async function parseGPX(url) {
  const text = await fetch(url).then(r => r.text());
  const doc = new DOMParser().parseFromString(text, 'application/xml');
  return Array.from(doc.querySelectorAll('trkpt')).map(pt => ({
    lat: parseFloat(pt.getAttribute('lat')),
    lon: parseFloat(pt.getAttribute('lon')),
    ele: parseFloat(pt.querySelector('ele')?.textContent || '0'),
  }));
}

function smooth(pts, w = 6) {
  return pts.map((p, i) => {
    const s = Math.max(0, i - w), e = Math.min(pts.length - 1, i + w);
    const avg = pts.slice(s, e + 1).reduce((sum, x) => sum + x.ele, 0) / (e - s + 1);
    return { ...p, ele: avg };
  });
}

// Build cumulative-distance series (feet), sampled every `step` points
function buildSeries(rawPts, step = 6) {
  const smoothed = smooth(rawPts, 6);
  const sampled  = smoothed.filter((_, i) => i % step === 0 || i === smoothed.length - 1);
  let cum = 0;
  return sampled.map((p, i) => {
    if (i > 0) cum += haversine(sampled[i-1].lat, sampled[i-1].lon, p.lat, p.lon);
    return { dist: cum, ele: metersToFeet(p.ele) };
  });
}

// ─── LOAD ALL + RENDER ───────────────────────────────────────────────────────

const loadLabel = document.getElementById('loading-label');
const loadFill  = document.getElementById('loading-fill');
let loaded = 0;
const allSeries = new Array(DAYS.length);

Promise.all(
  DAYS.map((d, i) =>
    parseGPX(d.gpx).then(raw => {
      loaded++;
      loadFill.style.width = `${(loaded / DAYS.length * 100).toFixed(0)}%`;
      loadLabel.textContent = `${loaded} / ${DAYS.length} tracks`;
      allSeries[i] = buildSeries(raw, 6);
    })
  )
).then(() => {
  document.getElementById('ridge-loading').style.display  = 'none';
  document.getElementById('ridge-svg').style.display      = 'block';
  document.getElementById('ridge-caption').style.display  = 'block';
  drawRidge();
});

// ─── DRAW ─────────────────────────────────────────────────────────────────────

function drawRidge() {
  const svgEl = document.getElementById('ridge-svg');
  const containerW = svgEl.parentElement.clientWidth;

  // Zero-baseline each day: subtract its starting elevation so each ridge starts at 0
  // This makes the shape (the change) readable, not the absolute altitude
  const zeroed = allSeries.map(series => {
    const base = series[0]?.ele || 0;
    return series.map(p => ({ ...p, ele: p.ele - base }));
  });

  // Global elevation range across all zero-baselined series
  const globalMaxGain = d3.max(zeroed, s => d3.max(s, p => p.ele)) || 1;
  const globalMinDrop = d3.min(zeroed, s => d3.min(s, p => p.ele)) || 0;

  // Layout
  const MAR = { top: 28, right: 90, bottom: 70, left: 160 };
  const PEAK_PX  = 110;
  const BELOW_PX = globalMinDrop < 0 ? Math.min(28, Math.abs(globalMinDrop) / globalMaxGain * PEAK_PX) : 0;
  const ROW_SPACING = 68;
  const SVG_W = containerW;
  const SVG_H = MAR.top + PEAK_PX + (DAYS.length - 1) * ROW_SPACING + BELOW_PX + MAR.bottom;
  const PLOT_W = SVG_W - MAR.left - MAR.right;

  svgEl.setAttribute('viewBox', `0 0 ${SVG_W} ${SVG_H}`);
  svgEl.setAttribute('height', SVG_H);
  while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);

  const svg = d3.select(svgEl);

  // Diverging y-scale anchored at 0: ele=0 always sits exactly at the baseline.
  // Positive elevation maps upward (PEAK_PX), negative maps downward (BELOW_PX).
  // A single linear scale over [minDrop, maxGain] shifts the zero point off-baseline
  // when the two extremes are unequal — the diverging approach fixes that.
  const yScPos = d3.scaleLinear().domain([0, globalMaxGain]).range([0, PEAK_PX]);
  const yScNeg = globalMinDrop < 0
    ? d3.scaleLinear().domain([0, globalMinDrop]).range([0, -BELOW_PX])
    : null;
  const ySc = val => val >= 0 ? yScPos(val) : (yScNeg ? yScNeg(val) : 0);

  // SVG filter for glow on ridge lines
  const defs = svg.append('defs');
  const filt = defs.append('filter').attr('id', 'glow').attr('x','-25%').attr('y','-25%').attr('width','150%').attr('height','150%');
  filt.append('feGaussianBlur').attr('in', 'SourceGraphic').attr('stdDeviation', '1.6').attr('result', 'blur');
  const merge = filt.append('feMerge');
  merge.append('feMergeNode').attr('in', 'blur');
  merge.append('feMergeNode').attr('in', 'SourceGraphic');

  // Render bottom→top: Day 9 first (behind), Day 1 last (in front)
  for (let i = DAYS.length - 1; i >= 0; i--) {
    const d       = DAYS[i];
    const series  = zeroed[i];
    const rawSeries = allSeries[i];
    const baseline  = MAR.top + PEAK_PX + i * ROW_SPACING;

    // Each day spans the FULL plot width, normalized 0→1
    const totalDist = series[series.length - 1]?.dist || 1;
    const xSc = d3.scaleLinear().domain([0, totalDist]).range([MAR.left, MAR.left + PLOT_W]);

    // SVG y of a point: above baseline (positive ele) → smaller y; below → larger y
    const yOf = p => baseline - ySc(p.ele);

    const dayG = svg.append('g');

    // Background fill: from the ridge line down to THIS ROW'S BASELINE only.
    // Using SVG_H here was the bug — it covered all rows below this one entirely.
    // With y0=baseline, each row's fill only masks content within its own elevation
    // window, letting taller rows behind it remain visible above the baseline.
    dayG.append('path')
      .datum(series)
      .attr('d', d3.area().x(p => xSc(p.dist)).y0(baseline).y1(yOf).curve(d3.curveBasis))
      .attr('fill', '#05090f');

    // Colored gradient fill between ridge and its baseline
    const gid = `rg${i}`;
    const grad = defs.append('linearGradient').attr('id', gid)
      .attr('gradientUnits', 'userSpaceOnUse').attr('x1', 0).attr('x2', 0)
      .attr('y1', baseline - PEAK_PX).attr('y2', baseline);
    grad.append('stop').attr('offset', '0%').attr('stop-color', d.color).attr('stop-opacity', 0.32);
    grad.append('stop').attr('offset', '100%').attr('stop-color', d.color).attr('stop-opacity', 0.04);

    dayG.append('path')
      .datum(series)
      .attr('d', d3.area().x(p => xSc(p.dist)).y0(baseline).y1(yOf).curve(d3.curveBasis))
      .attr('fill', `url(#${gid})`);

    // Ridge line with glow
    dayG.append('path')
      .datum(series)
      .attr('d', d3.line().x(p => xSc(p.dist)).y(yOf).curve(d3.curveBasis))
      .attr('fill', 'none').attr('stroke', d.color).attr('stroke-width', 1.5)
      .attr('filter', 'url(#glow)');

    // Thin baseline rule
    dayG.append('line')
      .attr('x1', MAR.left).attr('x2', MAR.left + PLOT_W)
      .attr('y1', baseline).attr('y2', baseline)
      .attr('stroke', d.color).attr('stroke-width', 0.25).attr('opacity', 0.18);

    // Day label (left)
    dayG.append('text')
      .attr('x', MAR.left - 12).attr('y', baseline + 4)
      .attr('text-anchor', 'end').attr('fill', d.color)
      .attr('font-family', 'Space Mono, monospace').attr('font-size', '10px').attr('font-weight', '700')
      .text(`Day ${d.day}`);
    dayG.append('text')
      .attr('x', MAR.left - 12).attr('y', baseline + 15)
      .attr('text-anchor', 'end').attr('fill', '#3e3a35')
      .attr('font-family', 'Raleway, sans-serif').attr('font-size', '9px')
      .text(d.from);

    // Distance label (right)
    dayG.append('text')
      .attr('x', MAR.left + PLOT_W + 10).attr('y', baseline + 4)
      .attr('text-anchor', 'start').attr('fill', '#3e3a35')
      .attr('font-family', 'Space Mono, monospace').attr('font-size', '8.5px')
      .text(`${d.miles} mi`);

    // ── Annotations on notable days ──

    // Day 5: Paisano Pass peak — label with absolute elevation
    if (d.day === 5) {
      const peakIdx = series.reduce((bi, p, j) => p.ele > series[bi].ele ? j : bi, 0);
      const pk = series[peakIdx];
      const absEle = Math.round(rawSeries[peakIdx]?.ele || 0);
      const px = xSc(pk.dist), py = yOf(pk);
      dayG.append('line').attr('x1', px).attr('x2', px).attr('y1', py - 5).attr('y2', py - 20)
        .attr('stroke', d.color).attr('stroke-width', 0.8).attr('opacity', 0.8);
      dayG.append('text').attr('x', px).attr('y', py - 23)
        .attr('text-anchor', 'middle').attr('fill', d.color)
        .attr('font-family', 'Space Mono, monospace').attr('font-size', '8px')
        .text(`${absEle.toLocaleString()} ft`);
    }

    // Day 6: Big Bend peak
    if (d.day === 6) {
      const peakIdx = series.reduce((bi, p, j) => p.ele > series[bi].ele ? j : bi, 0);
      const pk = series[peakIdx];
      const absEle = Math.round(rawSeries[peakIdx]?.ele || 0);
      const px = xSc(pk.dist), py = yOf(pk);
      dayG.append('text').attr('x', px + 6).attr('y', py - 4)
        .attr('fill', d.color).attr('opacity', 0.75)
        .attr('font-family', 'Space Mono, monospace').attr('font-size', '7.5px')
        .text(`${absEle.toLocaleString()} ft`);
    }

    // Day 9: Salton Sea trough
    if (d.day === 9) {
      const troughIdx = series.reduce((bi, p, j) => p.ele < series[bi].ele ? j : bi, 0);
      const tr = series[troughIdx];
      if (tr.ele < -100) {  // only label if a meaningful dip
        const absEle = Math.round(rawSeries[troughIdx]?.ele || 0);
        const px = xSc(tr.dist), py = yOf(tr);
        dayG.append('line').attr('x1', px).attr('x2', px).attr('y1', py + 4).attr('y2', py + 16)
          .attr('stroke', '#4a8fa8').attr('stroke-width', 0.8).attr('opacity', 0.8);
        dayG.append('text').attr('x', px).attr('y', py + 26)
          .attr('text-anchor', 'middle').attr('fill', '#4a8fa8')
          .attr('font-family', 'Space Mono, monospace').attr('font-size', '7.5px')
          .text(`${absEle} ft`);
      }
    }
  }

  // Bottom axis
  const axisY = MAR.top + PEAK_PX + (DAYS.length - 1) * ROW_SPACING + BELOW_PX + 18;
  // City endpoint labels
  svg.append('text').attr('x', MAR.left).attr('y', axisY + 16)
    .attr('text-anchor', 'middle').attr('fill', '#3e3a35')
    .attr('font-family', 'Raleway, sans-serif').attr('font-size', '9px')
    .text('Philadelphia');
  svg.append('text').attr('x', MAR.left + PLOT_W).attr('y', axisY + 16)
    .attr('text-anchor', 'middle').attr('fill', '#3e3a35')
    .attr('font-family', 'Raleway, sans-serif').attr('font-size', '9px')
    .text('California');
  // Subtle x-axis note
  svg.append('text').attr('x', MAR.left + PLOT_W / 2).attr('y', axisY + 16)
    .attr('text-anchor', 'middle').attr('fill', '#2a2820')
    .attr('font-family', 'Space Mono, monospace').attr('font-size', '7.5px')
    .text('← distance within each day →');
}

</script>
</MapBase>
